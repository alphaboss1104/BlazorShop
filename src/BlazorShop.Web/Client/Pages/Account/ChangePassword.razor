@page "/account/changepassword"
@attribute [Authorize]
@inject IToastService ToastService

<section class="page-title text-center">
    <div class="container relative clearfix">
        <div class="title-holder">
            <div class="title-text">
                <h1 class="uppercase">Change Password</h1>
            </div>
        </div>
    </div>
</section>

<section class="section-wrap woocommerce-account pt-0 pb-60">
    <div class="container">
        <div class="woocommerce">
            <nav class="woocommerce-MyAccount-navigation">
                <ul>
                    <li class="woocommerce-MyAccount-navigation-link woocommerce-MyAccount-navigation-link--orders">
                        <a href="#">Orders</a>
                    </li>
                    <li class="woocommerce-MyAccount-navigation-link woocommerce-MyAccount-navigation-link--edit-address">
                        <a href="#">Addresses</a>
                    </li>
                    <li class="woocommerce-MyAccount-navigation-link woocommerce-MyAccount-navigation-link--edit-account">
                        <a href="/account/settings">Account Settings</a>
                    </li>
                    <li class="woocommerce-MyAccount-navigation-link woocommerce-MyAccount-navigation-link--edit-account is-active">
                        <a href="/account/changepassword">Change Password</a>
                    </li>
                    <li class="woocommerce-MyAccount-navigation-link woocommerce-MyAccount-navigation-link--customer-logout">
                        <Logout />
                    </li>
                </ul>
            </nav>

            <div class="woocommerce-MyAccount-content">
                <EditForm Model="model" OnValidSubmit="SubmitAsync" class="woocommerce-EditAccountForm edit-account">

                    <ErrorsList ShowErrors="showErrors" Errors="errors" />
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <p class="woocommerce-form-row woocommerce-form-row--wide form-row form-row-wide">
                        <label for="password_current">Current password (leave blank to leave unchanged)</label>
                        <span class="password-input">
                            <InputText @bind-Value="model.Password" type="password" class="woocommerce-Input woocommerce-Input--password input-text" name="password_current" id="password_current" autocomplete="off" />
                        </span>
                    </p>
                    <p class="woocommerce-form-row woocommerce-form-row--wide form-row form-row-wide">
                        <label for="password_1">New password (leave blank to leave unchanged)</label>
                        <span class="password-input">
                            <InputText @bind-Value="model.NewPassword" type="password" class="woocommerce-Input woocommerce-Input--password input-text" name="password_1" id="password_1" autocomplete="off" />
                        </span>
                    </p>
                    <p class="woocommerce-form-row woocommerce-form-row--wide form-row form-row-wide">
                        <label for="password_2">Confirm new password</label>
                        <span class="password-input">
                            <InputText @bind-Value="model.ConfirmNewPassword" type="password" class="woocommerce-Input woocommerce-Input--password input-text" name="password_2" id="password_2" autocomplete="off" />
                        </span>
                    </p>

                    <p>
                        <button type="submit" class="btn btn-lg woocommerce-Button button" name="save_account_details" value="Save changes">
                            Save changes
                        </button>
                    </p>

                    <div class="clear"></div>

                </EditForm>
            </div>

        </div>
    </div>
</section>

@code {
    private readonly ChangePasswordRequestModel model = new ChangePasswordRequestModel();

    private bool showErrors;
    private IEnumerable<string> errors;

    private async Task SubmitAsync()
    {
        var token = await this.LocalStorage.GetItemAsync<string>("authToken");
        this.Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

        var response = await this.Http.PutAsJsonAsync("api/identity/changepassword", this.model);

        if (response.IsSuccessStatusCode)
        {
            this.showErrors = false;

            this.model.Password = null;
            this.model.NewPassword = null;
            this.model.ConfirmNewPassword = null;

            this.NavigationManager.NavigateTo("/account/profile");
            this.ToastService.ShowSuccess("Your password has been changed successfully!");
        }
        else
        {
            this.errors = await response.Content.ReadFromJsonAsync<string[]>();
            this.showErrors = true;
        }
    }
}
